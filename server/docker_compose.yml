version: '3.8'

services:
  # Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        INSTALL_OPENAI: "true"
        INSTALL_GEMINI: "true"
    container_name: protocol-wizard-api
    ports:
      - "8000:8000"
    environment:
      # LLM Configuration
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gemini:gemini-1.5-flash}
      
      # LLM Behavior
      - LLM_MAX_RETRIES=${LLM_MAX_RETRIES:-3}
      - LLM_TIMEOUT_SECONDS=${LLM_TIMEOUT_SECONDS:-60}
      - LLM_BASE_DELAY=${LLM_BASE_DELAY:-1.0}
      - LLM_MAX_DELAY=${LLM_MAX_DELAY:-10.0}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.0}
      
      # CORS
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:5173}
      
      # Observability
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FORMAT=${LOG_FORMAT:-text}
      - ENABLE_METRICS=${ENABLE_METRICS:-false}
      
      # Rate Limiting
      - ENABLE_RATE_LIMITING=${ENABLE_RATE_LIMITING:-false}
      - RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE:-60}
      - RATE_LIMIT_BURST=${RATE_LIMIT_BURST:-10}
      
      # Request Size
      - ENABLE_SIZE_LIMITING=${ENABLE_SIZE_LIMITING:-true}
      - MAX_REQUEST_SIZE=${MAX_REQUEST_SIZE:-1048576}
    volumes:
      # Mount prompts and schemas for easy updates
      - ./prompts:/app/prompts:ro
      - ./schemas:/app/schemas:ro
    networks:
      - protocol-wizard-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Frontend (Optional - uncomment if you have a frontend)
  # frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #   container_name: protocol-wizard-frontend
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     - VITE_API_URL=http://localhost:8000
  #   depends_on:
  #     - backend
  #   networks:
  #     - protocol-wizard-net
  #   restart: unless-stopped

  # Prometheus (Optional - for metrics)
  prometheus:
    image: prom/prometheus:latest
    container_name: protocol-wizard-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - protocol-wizard-net
    restart: unless-stopped
    profiles:
      - monitoring

  # Grafana (Optional - for visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: protocol-wizard-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - protocol-wizard-net
    restart: unless-stopped
    profiles:
      - monitoring

networks:
  protocol-wizard-net:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data: